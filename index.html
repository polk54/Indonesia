<!DOCTYPE html>
<svg width="1000" height="960" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
<style>
    .legend {
        padding: 5px;
        font: 10px;
        font-family: "Franklin Gothic", Arial, sans-serif;
        background: yellow;
        box-shadow: 2px 2px 1px #888;
    }
    .toolTip {
        font-family: "Franklin Gothic", Arial, sans-serif;
        position: absolute;
        display: none;
        width: auto;
        height: auto;
        background: none repeat scroll 0 0 white;
        border: 0 none;
        border-radius: 8px 8px 8px 8px;
        box-shadow: -3px 3px 15px #888888;
        color: black;
        font: 12px sans-serif;
        padding: 5px;
        text-align: center;
    }
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    var div = d3.select("body").append("div").attr("class", "toolTip");
    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var format = d3.format(",d");
    
    var pack = d3.pack()
        .size([width, height])
        .padding(1.5);

    var colors = [
        "#1c3664",
        "#274c8b",
        "#3262b3",
        "#4c7bcd",
        "#7498d8",
        "#9cb6e3",
        "#c3d3ee"
    ];  
    
    // Grabs all the data from the OpenFEMA API
    d3.csv("https://www.fema.gov/api/open/v1/RegistrationIntakeIndividualsHouseholdPrograms.csv")
        .row(function(d){
            return {
                disaster: d.disasterNumber,
                amount: +d.ihpAmount
            }
        })
        .get(function(error, data){
            if (error) throw error;
        
            var completeData = [];
            var disasters = [];
            var categories = [0, 1, 2, 3, 4, 5, 6];
            var catRange = [1000000000, 500000000, 100000000, 50000000, 10000000, 5000000, 0]
            var total;
    
            // Creates an array of disasters for building the final object below
            data.forEach(function(row){ 
                if (row.disaster !== "" && disasters.indexOf(row.disaster) === -1) {
                    disasters.push(row.disaster)
                }
            })
   
            // Loop over each disaster
            disasters.forEach(function(disaster){
                var dataObject = {};
                total = 0;
                
                // Calculate cost per state
                data.forEach(function(row){
                   if(disaster === row.disaster){
                       total += row.amount;
                   }
                });
                
                dataObject["disaster"] = disaster;
                dataObject["total"] = (Math.round(total * 100) / 100);
                
                // Breaks disasters into categories based on total cost for use in color circles
                if (total >= catRange[0]) {
                    dataObject["category"] = 0;
                } else if (total >= catRange[1]) {
                    dataObject["category"] = 1;
                } else if (total >= catRange[2]) {
                    dataObject["category"] = 2;
                } else if (total >= catRange[3]) {
                    dataObject["category"] = 3;
                } else if (total >= catRange[4]) {
                    dataObject["category"] = 4;
                } else if (total >= catRange[5]) {
                    dataObject["category"] = 5;
                } else {
                    dataObject["category"] = 6;
                }
                
                // Final object with state and cost
                completeData.push(dataObject);
            });

            // Constructs the root object used by the D3 package    
            var root = d3.hierarchy({children: completeData})
                .sum(function(d) { return d.total; })

            // Breaks root into children for circles
            var node = svg.selectAll(".node")
                .data(pack(root).leaves())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

            // Constructs circles
            node.append("circle")
                .attr("id", function(d) { return d.disaster; })
                .attr("r", function(d) { return d.r; })
                .style("stroke", "DCDCDC")
                .style("fill", function(d) { return colors[d.data.category]; });

            // Lebels for larger circles
            node.append("text")
                .text(function(d) { 
                    if (d.data.total > 30000000){
                        return d.data.disaster; 
                    }
                })
                .style("fill", "#fff");

            // Tooltips
            node.on("mousemove", function(d){
                // Formats the total to be more readable on the tooltip
                var formattedTotal = d.data.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); 
                div.style("left", d3.event.pageX+10+"px");
                div.style("top", d3.event.pageY-25+"px");
                div.style("display", "inline-block");
                div.html("Disaster #" + d.data.disaster + "<br />" + "Total: $"+(formattedTotal));
            });

            node.on("mouseout", function(d){
                div.style("display", "none");
            });
        
            // Legend for chart
            var legend = svg.append("g")
                .attr("class", "legend")
                .attr("x", width - 65)
                .attr("y", 25)
                .attr("height", 100)
                .attr("width", 100);

            var yValue = 25;
            categories.forEach(function(cat){   
                legend.append("rect")
                    .attr("x", 55)
                    .attr("y", yValue)
                    .attr("width", 20)
                    .attr("height", 10)
                    .style("fill", function(d) { return colors[cat] });
                              
            legend.append("text")
                .attr("x", 85)
                .attr("y", yValue + 8)
                .style("text-anchor", "start")
                .text(function(d) { return "Total Cost Above $" + catRange[cat].toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") });
                
            yValue += 15;
            })
        
        })
</script>
